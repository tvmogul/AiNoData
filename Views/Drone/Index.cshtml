@model AiNoData.Models.Drone.DroneHoverViewModel

@{
    var scriptNonce = Html.ScriptNonce();
    ViewData["Title"] = "Zero-Training AI™ Drone Orientation – Energy Dynamics Demo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* =========================
           DRONE ORIENTATION VISUAL
           SVG-BASED (NOT FLIGHT)
           ========================= */

    .drone-visual-wrapper {
        width: 100%;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 50% 30%, #f7f7f7, #dedede);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }

    .axis-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .axis-label {
        position: absolute;
        font-size: 0.75rem;
        color: #666;
        background: rgba(255,255,255,0.7);
        padding: 2px 6px;
        border-radius: 6px;
    }

    .axis-x {
        left: 10px;
        bottom: 50%;
        transform: translateY(50%);
    }

    .axis-y {
        right: 10px;
        bottom: 50%;
        transform: translateY(50%);
    }

    .axis-z {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
    }

    .drone-svg {
        width: 160px;
        height: 160px;
        transform-style: preserve-3d;
        transition: transform 0.08s linear;
        filter: drop-shadow(0 12px 20px rgba(0,0,0,0.25));
    }

    .drone-info {
        margin-top: 10px;
        font-size: 0.9rem;
    }

        .drone-info span {
            display: inline-block;
            min-width: 110px;
        }
</style>

<div style="margin-top: 30px !important;">
    <div style="position: relative; max-width: 800px; margin: 0 auto;">
        <canvas id="netcanvas" width="800" height="70" style="display: block; width: 100%; height: 70px; border: none transparent;"></canvas>
        <div style="text-align: center;" class="table-block">
            <h2 style="margin-top: -50px; white-space: nowrap;">
                <img src="/img/title_drone.gif" alt="Settings" style="height: 50px; vertical-align: top; margin-top: -12px;margin-right: 4px;">
                Zero-Training AI™ Drone Orientation<br />Energy Dynamics Demo
            </h2>
        </div>
    </div>
</div>
<br />

<div class="container" style="margin-top: 25px;">
    <p class="text-muted" style="max-width: 900px;">
        This demo visualizes <strong>orientation dynamics only</strong>. The drone does not translate or fly through space.
        Its position is fixed. What you see is how roll, pitch, and yaw respond to disturbance and stabilize as the
        internal energy of the system evolves.
    </p>

    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <strong>Simulation Controls</strong>
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="post">

                        <button type="submit" class="btn btn-primary w-100">
                            Recompute Simulation
                        </button>

                        <div class="mb-3">
                            <label class="form-label">Time Steps</label>
                            <input asp-for="TimeSteps" class="form-control" type="number" min="10" max="1000" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Δt (time step)</label>
                            <input asp-for="Dt" class="form-control" type="number" step="0.01" min="0.01" max="1" />
                        </div>

                        <hr />

                        <h6 class="fw-bold">Wind / Fan Disturbance</h6>

                        <div class="mb-3">
                            <label class="form-label">
                                Blast Start Step
                                (<span id="blastStartDisplay">@Model.Environment.BlastStartStep</span>)
                            </label>
                            <input asp-for="Environment.BlastStartStep"
                                   id="blastStartInput"
                                   class="form-range"
                                   type="range"
                                   min="0"
                                   max="@Model.TimeSteps"
                                   step="1"
                                   oninput="document.getElementById('blastStartDisplay').innerText = this.value" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Blast End Step
                                (<span id="blastEndDisplay">@Model.Environment.BlastEndStep</span>)
                            </label>
                            <input asp-for="Environment.BlastEndStep"
                                   id="blastEndInput"
                                   class="form-range"
                                   type="range"
                                   min="0"
                                   max="@Model.TimeSteps"
                                   step="1"
                                   oninput="document.getElementById('blastEndDisplay').innerText = this.value" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Blast Torque (Roll)</label>
                            <input asp-for="Environment.BlastDisturbanceRoll"
                                   id="blastTorqueInput"
                                   class="form-control"
                                   type="number"
                                   step="0.05"
                                   min="-2.0"
                                   max="2.0" />
                        </div>

                        <hr />

                        <h6 class="fw-bold">Initial Attitude</h6>
                        <div class="mb-2">
                            <label class="form-label">Roll</label>
                            <input asp-for="InitialState.Roll" class="form-control" type="number" step="0.01" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Pitch</label>
                            <input asp-for="InitialState.Pitch" class="form-control" type="number" step="0.01" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Yaw</label>
                            <input asp-for="InitialState.Yaw" class="form-control" type="number" step="0.01" />
                        </div>

                        <hr />
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <strong>Drone Orientation (3-Axis + Energy)</strong>
                </div>
                <div class="card-body">
                    <div class="drone-visual-wrapper">
                        <svg id="droneSvg" class="drone-svg" viewBox="0 0 200 200">
                            <!-- Arms -->
                            <line x1="40" y1="100" x2="160" y2="100" stroke="#555" stroke-width="8" />
                            <line x1="100" y1="40" x2="100" y2="160" stroke="#555" stroke-width="8" />

                            <!-- Rotors -->
                            <circle cx="40" cy="100" r="14" fill="#333" />
                            <circle cx="160" cy="100" r="14" fill="#333" />
                            <circle cx="100" cy="40" r="14" fill="#333" />
                            <circle cx="100" cy="160" r="14" fill="#333" />

                            <!-- Body -->
                            <rect x="70" y="70" width="60" height="60" rx="14" fill="#e6e6e6" stroke="#444" stroke-width="4" />

                            <!-- Camera / Nose (front indicator) -->
                            <polygon points="100,55 92,70 108,70" fill="#cc0000" />
                        </svg>

                        <div class="axis-overlay">
                            <div class="axis-label axis-x">Roll (X)</div>
                            <div class="axis-label axis-y">Pitch (Y)</div>
                            <div class="axis-label axis-z">Yaw / Energy (Z)</div>
                        </div>
                    </div>

                    <div class="drone-info mt-2">
                        <span>Roll: <strong><span id="rollReadout">0</span></strong></span>
                        <span>Pitch: <strong><span id="pitchReadout">0</span></strong></span>
                        <span>Yaw: <strong><span id="yawReadout">0</span></strong></span>
                        <span>Energy: <strong><span id="energyReadout">0</span></strong></span>
                    </div>

                    <div class="form-text mt-2">
                        Rotation shows orientation (roll, pitch, yaw). Size changes reflect internal energy
                        magnitude F(q,p). This is <strong>not</strong> a flight or position simulation.
                    </div>

                    <section class="demo-explainer" aria-labelledby="demo-title">
                        <h2 id="demo-title">What This Demo Shows</h2>

                        <p>
                            This visualization represents a drone’s <strong>orientation dynamics</strong>, not its motion through space.
                            The drone is assumed to be hovering at a fixed position while its attitude (roll, pitch, yaw)
                            responds to disturbances and stabilizes over time.
                        </p>

                        <p>
                            The system is governed by a <strong>Zero-Training AI™ energy-based decision engine</strong>.
                            Internally, the engine evolves state variables (<em>q</em>, <em>p</em>) — orientation and momentum —
                            according to a mathematical energy function:
                        </p>

                        <figure class="equation" aria-label="Energy function">
                            <div class="math">
                                <span class="math-italic">F</span>(<span class="math-italic">q</span>, <span class="math-italic">p</span>)
                                =
                                <span class="frac" aria-hidden="true"><span class="top">1</span><span class="bar"></span><span class="bot">2</span></span>
                                <span class="sr-only">one half</span>
                                <span class="sum">∑</span><sub>i</sub> <span class="math-italic">p</span><sub>i</sub><sup>2</sup>
                                − <span class="math-italic">α</span>
                                <span class="sum">∑</span><sub>i</sub> (<span class="math-italic">ROI</span><sub>i</sub> · <span class="math-italic">q</span><sub>i</sub>)
                                + <span class="math-italic">λ</span>(<span class="sum">∑</span><sub>i</sub> <span class="math-italic">q</span><sub>i</sub> − 1)<sup>2</sup>
                            </div>
                        </figure>

                        <p>
                            During a wind or fan blast, external torque injects energy into the system.
                            Once the disturbance ends, the dynamics naturally drive the system back toward
                            a low-energy, stable hover.
                        </p>

                        <h3>What You Are Seeing</h3>
                        <ul>
                            <li>Rotation shows orientation (roll, pitch, yaw)</li>
                            <li>Size changes show internal energy magnitude (control effort)</li>
                            <li>No translation occurs — position is fixed</li>
                        </ul>

                        <p>
                            This is <strong>not</strong> a flight simulator and does not rely on training data, rules,
                            or learned models. Stability and recovery emerge directly from the mathematical
                            structure of the system itself.
                        </p>

                    </section>


                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script nonce="@scriptNonce">
        (function () {
            const snapshots = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Timeline ?? new List<AiNoData.Models.Drone.DroneSimulationSnapshot>()));
            const drone = document.getElementById("droneSvg");
            const rollR = document.getElementById("rollReadout");
            const pitchR = document.getElementById("pitchReadout");
            const yawR = document.getElementById("yawReadout");
            const energyR = document.getElementById("energyReadout");

            if (!snapshots.length) return;

            const energies = snapshots.map(s => s.Energy);
            const E0 = energies[0];
            const k = 0.25;

            let idx = 0;
            setInterval(() => {
                const s = snapshots[idx];
                const roll = s.State.Roll * 57.2958;
                const pitch = s.State.Pitch * 57.2958;
                const yaw = s.State.Yaw * 57.2958;

                let scale = 1 + k * (s.Energy - E0);
                if (scale < 0.85) scale = 0.85;
                if (scale > 1.25) scale = 1.25;

                drone.style.transform =
                    `rotateX(${-pitch}deg) rotateZ(${roll}deg) rotateY(${yaw}deg) scale(${scale})`;

                rollR.textContent = roll.toFixed(1) + "°";
                pitchR.textContent = pitch.toFixed(1) + "°";
                yawR.textContent = yaw.toFixed(1) + "°";
                energyR.textContent = s.Energy.toFixed(3);

                idx = (idx + 1) % snapshots.length;
            }, 60);
        })();
    </script>
}

<style>
    .demo-explainer {
        line-height: 1.55;
    }

        .demo-explainer h2 {
            margin: 0 0 0.75rem 0;
        }

        .demo-explainer h3 {
            margin: 1.25rem 0 0.5rem 0;
        }

        .demo-explainer p {
            margin: 0 0 1rem 0;
        }

        .demo-explainer ul {
            margin: 0.25rem 0 1rem 1.25rem;
        }

    .equation {
        margin: 0.75rem 0 1rem 0;
    }

    .math {
        font-family: ui-serif, "Times New Roman", Times, serif;
        font-size: 1.05rem;
    }

    .math-italic {
        font-style: italic;
    }

    .sum {
        font-size: 1.2em;
        vertical-align: -0.05em;
    }

    .frac {
        display: inline-block;
        vertical-align: middle;
        margin: 0 0.1em;
    }

        .frac .top, .frac .bot {
            display: block;
            text-align: center;
            line-height: 1.0;
            font-size: 0.95em;
        }

        .frac .bar {
            display: block;
            border-top: 1px solid currentColor;
            margin: 0.05em 0;
        }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
</style>